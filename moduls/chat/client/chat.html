<template name="chat">
	<div class="chat">
		{{#if users}}
			<ul class="participants">
				{{#each users}}
					<li class="online">
						<span>{{this}}</span>
						{{#if canControlUsers}}
							<a class="remove" data-username="{{this}}">Удалить</a>
						{{/if}}
					</li>
				{{/each}}
				{{#if canControlRoom}}
					<li><a class="addModerator" href="#">Назначить модератора</a></li>
					<li><a class="removeModerator" href="#">Разжаловать модератора</a></li>
					<li><a class="removeRoom" href="#">Удалить конмату</a></li>
				{{/if}}
				<li><a class="createRoom" href="#">Создать комнату</a></li>
			</ul>
		{{/if}}

		<ul class="messages">
			{{#if hasMore}}
				<li class="more">Показать предыдущие</li>
			{{/if}}
			{{#if gotLimit}}
				<li class="limit">Не могу показать больше чем {{maxMessages}} сообщений</li>
			{{/if}}
			{{#each messages}}
				<li
					data-tooltip="{{#if not this.isMotd}}{{formatDate this.timestamp -180}}{{/if}}"
					data-tooltip-direction="w"
					class="
						{{this.role}} 
						{{#if this.data}}status{{/if}} 
						{{this.data.type}} 
						{{#if this.isMotd}}motd{{/if}}
					"
				>
					{{#if this.data}}* {{/if}}
					<span 
						class="
							{{#if eqandtrue this.alliance user.alliance}}ally{{/if}} 
							{{#if eq this.username user.username}}me{{/if}}"
					>
						{{this.username}}{{#unless this.data}}:{{/unless}}
					</span>
					{{#if this.data}}
						{{#if eq this.data.type 'dice'}}
							бросил {{this.data.dice.dices.amount}} кубик(а, ов) с {{this.data.dice.edges}} гранями каждый: 
							{{#each this.data.dice.dices.values}}
								<span class="dice">{{this}}</span> 
							{{/each}}
						{{/if}}
						{{#if eq this.data.type 'status'}}
							{{{highlightUser this.message}}}
						{{/if}}
						{{#if eq this.data.type 'notprepared'}}
							{{{highlightUser this.message}}}
						{{/if}}
						{{#if eq this.data.type 'lovereptiles'}}
							{{{highlightUser this.message}}}
						{{/if}}
						{{#if eq this.data.type 'sepukku'}}
							совершил кровавое сепукку.
						{{/if}}
						{{#if eq this.data.type 'unblock'}}
							разблокировал
							{{#if data.global}} все чаты {{else}} этот чат {{/if}}
							для {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'block'}}
							заблокировал
							{{#if data.global}} все чаты {{else}} этот чат {{/if}}
							для {{this.message}} до {{formatDate (sum data.timestamp data.period) -180}}
						{{/if}}
						{{#if eq this.data.type 'add'}}
							добавил в чат {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'remove'}}
							удалил из чата {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'addModerator'}}
							назначил модератора {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'removeModerator'}}
							разжаловал модератора {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'addfunds'}}
							пополнил баланс чата на {{this.data.amount}} ГГК
						{{/if}}
					{{else}}
						{{{highlightUser this.message}}}
					{{/if}}
					{{#if canControlBlock}}
						<a class="block" data-username="{{this.username}}" href="#">Наказать</a>
						<a class="unblock" data-username="{{this.username}}" href="#">Простить</a>
					{{/if}}
				</li>
			{{/each}}
		</ul>

		<form id="message">
			<textarea name="text" maxlength="140"></textarea>
			<input type="submit" value="Послать">
			{{#if price}}
				<ul class="resources" title="Стоимость сообщения">
					{{#if price.crystals}}
						<li class="crystals">{{price.crystals}}</li>
					{{/if}}
					{{#if price.credits}}
						<li class="credits">{{price.credits}}</li>
					{{/if}}
				</ul>
			{{/if}}

			{{#if room}}
				{{#if room.isOwnerPays}}
					<ul class="resources" title="Баланс комнаты">
						<li class="credits addCredits">{{room.credits}}</li>
					</ul>
				{{/if}}
			{{/if}}

			{{#if price}}
				{{#unless isChatFree}}
					<button class="buyFreeChat">Больше никогда не платить за ссаный чат</button>
					<ul class="resources">
						<li class="credits">{{formatNumberWithISO freeChatPrice}}</li>
					</ul>
				{{/unless}}
			{{/if}}
		</form>

		{{#if canControlUsers}}
			<form id="control">
				<input name="username" />
				<input type="submit" value="Добавить" />
			</form>
		{{/if}}
	</div>

	{{> chatRoomsList}}
</template>

<template name="chatRoomsList">
	{{#if rooms}}
		<ul class="chatRoomsList">
			{{#each rooms}}
				<li class="{{this.name}}">
					<a href="{{pathFor 'chat' room=this.name}}">
						{{#if this.title}}{{this.title}}{{else}}{{this.name}}{{/if}}
					</a>
				</li>
			{{/each}}
		</ul>
	{{/if}}
</template>

<template name="chatAccept">
	<div class="smoke"></div>
	<div class="chatAccept">
		<div class="close"></div>
		<span class="title">Подтвердите действие</span>
		<span class="message">{{message}}</span>
		<div class="button accept">Да</div>
		<div class="button cancel">Нет</div>
	</div>
</template>

<template name="chatHelp">
	<div class="smoke"></div>
	<div class="chatHelp">
		<div class="close"></div>

		<div class="tabCommands">Команды чата</div>
		<div class="tabRules">Правила чата</div>

		<div class="commands">
			<table>
				<tr><td>/create channel</td><td>создать комнату</td></tr>
				<tr><td>/remove channel</td><td>удалить текущую комнату</td></tr>
				<tr><td>/join [channel]</td><td>присоединиться к комнате</td></tr>
				<tr><td>/add credits [amount]</td><td>пополнить баланс комнаты</td></tr>
				<tr><td>/add user [username]</td><td>добавить пользователя к комнате</td></tr>
				<tr><td>/remove user [username]</td><td>удалить пользователя из комнаты</td></tr>
				<tr><td>/block [username]</td><td>наказать пользователя</td></tr>
				<tr><td>/unblock [username]</td><td>простить пользователя</td></tr>
				<tr><td>/add moderator [username]</td><td>назначить модератора</td></tr>
				<tr><td>/remove moderator [username]</td><td>разжаловать модератора</td></tr>
				<tr><td>/d [n] [m]</td><td>бросить n кубиков с m гранями</td></tr>
				<tr><td>/me [text]</td><td>писать от третьего лица</td></tr>
				<tr><td>/сепукку</td><td>совершить сепукку и пожертвовать ресурсы</td></tr>
				<tr><td>/яготов</td><td>вы действительно так думаете?</td></tr>
				<tr><td>/ilovereptiles</td><td>признаться в любви к Рептилоидам</td></tr>
			</table>
		</div>

		<div class="rules">
			<p>TODO: Сверстать правила!</p>
		</div>
	</div>
</template>

<template name="chatBalance">
	<div class="smoke"></div>
	<div class="chatBalance">
		<div class="close"></div>

		<label>
			<span class="title">Сумма пополениня в ГГК</span>
			<input type="text" name="credits" value="{{credits}}"/>
		</label>
		<div class="button accept">Пополнить</div>

		<span class="historyTitle">История пополнения</span>
		<div class="data">
			<table>
				<tr>
					<td>Валера</td>
					<td>500</td>
					<td>12.05.16</td>
				</tr>
			</table>
		</div>

		<div class="pages"></div>
	</div>
</template>

<template name="chatBlock">
	<div class="smoke"></div>
	<div class="chatBlock">
		<div class="close"></div>
		настройки + создание
	</div>
</template>

<template name="chatSettings">
	<div class="smoke"></div>
	<div class="chatSettings">
		<div class="close"></div>
		настройки + создание
	</div>
</template>

<template name="chatIcons">
	<div class="smoke"></div>
	<div class="chatIcons">
		<div class="close"></div>
		иконки
	</div>
</template>