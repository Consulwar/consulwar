<template name="chat">
	<div class="chat">
		{{#if users}}
			<ul class="participants">
				{{#each users}}
					<li class="online">
						<span>{{this}}</span>
						{{#if canControlUsers}}
							<a class="remove" data-username="{{this}}">Удалить</a>
						{{/if}}
					</li>
				{{/each}}
				{{#if canControlRoom}}
					<li><a class="addModerator" href="#">Назначить модератора</a></li>
					<li><a class="removeModerator" href="#">Разжаловать модератора</a></li>
					<li><a class="removeRoom" href="#">Удалить конмату</a></li>
				{{/if}}
				<li><a class="createRoom" href="#">Создать комнату</a></li>
			</ul>
		{{/if}}

		<ul class="messages">
			{{#if hasMore}}
				<li class="more">Показать предыдущие</li>
			{{/if}}
			{{#if gotLimit}}
				<li class="limit">Не могу показать больше чем {{maxMessages}} сообщений</li>
			{{/if}}
			{{#each messages}}
				<li
					data-tooltip="{{#if not this.isMotd}}{{formatDate this.timestamp -180}}{{/if}}"
					data-tooltip-direction="w"
					class="
						{{this.role}} 
						{{#if this.data}}status{{/if}} 
						{{this.data.type}} 
						{{#if this.isMotd}}motd{{/if}}
					"
				>
					{{#if this.data}}* {{/if}}
					<span 
						class="
							{{#if eqandtrue this.alliance user.alliance}}ally{{/if}} 
							{{#if eq this.username user.username}}me{{/if}}"
					>
						{{this.username}}{{#unless this.data}}:{{/unless}}
					</span>
					{{#if this.data}}
						{{#if eq this.data.type 'dice'}}
							бросил {{this.data.dice.dices.amount}} кубик(а, ов) с {{this.data.dice.edges}} гранями каждый: 
							{{#each this.data.dice.dices.values}}
								<span class="dice">{{this}}</span> 
							{{/each}}
						{{/if}}
						{{#if eq this.data.type 'status'}}
							{{{highlightUser this.message}}}
						{{/if}}
						{{#if eq this.data.type 'notprepared'}}
							{{{highlightUser this.message}}}
						{{/if}}
						{{#if eq this.data.type 'lovereptiles'}}
							{{{highlightUser this.message}}}
						{{/if}}
						{{#if eq this.data.type 'sepukku'}}
							совершил кровавое сепукку.
						{{/if}}
						{{#if eq this.data.type 'unblock'}}
							разблокировал
							{{#if data.global}} все чаты {{else}} этот чат {{/if}}
							для {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'block'}}
							заблокировал
							{{#if data.global}} все чаты {{else}} этот чат {{/if}}
							для {{this.message}} до {{formatDate (sum data.timestamp data.period) -180}}
						{{/if}}
						{{#if eq this.data.type 'add'}}
							добавил в чат {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'remove'}}
							удалил из чата {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'addModerator'}}
							назначил модератора {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'removeModerator'}}
							разжаловал модератора {{this.message}}
						{{/if}}
						{{#if eq this.data.type 'addfunds'}}
							пополнил баланс чата на {{this.data.amount}} ГГК
						{{/if}}
					{{else}}
						{{{highlightUser this.message}}}
					{{/if}}
					{{#if canControlBlock}}
						<a class="block" data-username="{{this.username}}" href="#">Наказать</a>
						<a class="unblock" data-username="{{this.username}}" href="#">Простить</a>
					{{/if}}
				</li>
			{{/each}}
		</ul>

		<form id="message">
			<textarea name="text" maxlength="140"></textarea>
			<input type="submit" value="Послать">
			{{#if price}}
				<ul class="resources" title="Стоимость сообщения">
					{{#if price.crystals}}
						<li class="crystals">{{price.crystals}}</li>
					{{/if}}
					{{#if price.credits}}
						<li class="credits">{{price.credits}}</li>
					{{/if}}
				</ul>
			{{/if}}

			{{#if room}}
				{{#if room.isOwnerPays}}
					<ul class="resources" title="Баланс комнаты">
						<li class="credits addCredits">{{room.credits}}</li>
					</ul>
				{{/if}}
			{{/if}}

			{{#if price}}
				{{#unless isChatFree}}
					<button class="buyFreeChat">Больше никогда не платить за ссаный чат</button>
					<ul class="resources">
						<li class="credits">{{formatNumberWithISO freeChatPrice}}</li>
					</ul>
				{{/unless}}
			{{/if}}
		</form>

		{{#if canControlUsers}}
			<form id="control">
				<input name="username" />
				<input type="submit" value="Добавить" />
			</form>
		{{/if}}
	</div>

	{{> chatRoomsList}}
</template>

<template name="chatRoomsList">
	{{#if rooms}}
		<ul class="chatRoomsList">
			{{#each rooms}}
				<li class="{{this.name}}">
					<a href="{{pathFor 'chat' room=this.name}}">
						{{#if this.title}}{{this.title}}{{else}}{{this.name}}{{/if}}
					</a>
				</li>
			{{/each}}
		</ul>
	{{/if}}
</template>