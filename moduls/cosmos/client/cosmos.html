<template name="cosmos">
  <div class="permanent">
    <div id="map-battle-container">
      <div id="map-battle"></div>
    </div>
    <button class="map-control-home"></button>
    <a class="btn-history" href="{{pathFor 'cosmosHistory' page=1}}" data-sound="click">История боёв</a>
    {{#if possibleDesync}}
      <div class="possibleDesync">Возможен рассинхрон. Обновите страницу.</div>
    {{/if}}
    {{#if isSelection}}
      <a class="btn-selection" href="{{pathFor 'cosmos'}}" data-sound="click">Сбросить выделение</a>
    {{/if}}
    {{#if and (gte user.rating 100000) (not isMutualSpace)}}
      <a class="btn-mutual-space" data-sound="click">Общий космос</a>
    {{/if}}
    
    {{#if isLoading}}
      {{> loading}}
    {{/if}}
  </div>
</template>


<template name="cosmosAttackMenu">
  <div class="attack-menu">
    <div class="departure">
      {{> UnitsReinforcement args
        activeSquad=activeSquad
        selectAllUnits=selectAllUnits
        colonyId=activeColonyId
        isSelectedAll=isSelectedAll
        selectedUnits=selectedUnits
        isSpace=true
        units=units
        className='cw--SpaceAttackMenu__reinforcement'
      }}
      
      <div class="planets scrollbar-inner">
        {{#each colonies}}
          {{#if this.canBuy}}
            {{> SpacePlanet args
              planet=this
              className='cw--CosmosAttackMenu__planet'
            }}
          {{else}}
            {{> SpacePlanet args
                planet=this
                location=(or 
                  (and 
                    (and 
                      options.showDistanceFromPlanets 
                      (not (or this.isEmpty this.notAvaliable))
                    )
                    (or 
                      (and this.timeAttack (formatSeconds this.timeAttack))
                      '–'
                    )
                  ) 
                  ' '
                )
                isSelected=(eqandtrue activeColonyId this._id)
                isDisabled=(eqandtrue ../id this._id)
                isTopTime=this.isTopTime
                className='cw--CosmosAttackMenu__planet'
            }}
          {{/if}}
        {{/each}}
      </div>

      <div class="squads">
        {{#each squads}}
          <div 
            class="
              squad 
              {{#if noPremium}}noPremium{{/if}} 
              {{#if noAdmiral}}noAdmiral{{/if}}
              {{#if eq activeSquad.slot this.slot}}active{{/if}}
            " 
            data-id="{{this.slot}}
          ">
            {{#if this.icon}}
              <img src="/img/game/chat/icons/{{this.icon}}sm.png"/>
            {{else}}
              <img src="/img/game/cosmomap/add.png"/>
            {{/if}}
            <span>
              {{#if this.name}}
                {{this.name}}
              {{else}}{{#if noPremium}}
                Нужен премиум
              {{else}}{{#if noAdmiral}}
                Отсутствует адмирал
              {{/if}}{{/if}}{{/if}}

              {{#if not (or noPremium noAdmiral)}}
                <button class="edit" data-id=""></button>
              {{/if}}
            </span>
          </div>
        {{/each}}

        <div class="control {{#if activeSquad}}active{{/if}}">
          <button class="save"></button>
          <button class="link"></button>
          <button class="remove"></button>
        </div>
      </div>

      <div class="unitsAdditionalControl">
        {{> UnitsPower args
          units=selectedUnits.get
        }}
        <button
          data-sound="click"
          onClick={{toggleSelectAllUnits}}
          class="
            cw--button
            cw--button_flat
            cw--button_flat_blue
          "
          style="font-size:16px; width:100%"
        >
          {{#if isSelectedAll.get}}
            Отменить выбор
          {{else}}
            Выбрать всех
          {{/if}}
        </button>
      </div>
    </div>


    <div class="target">
      {{#if planet}}
        {{> SpacePlanetPopup args
          planet=planet
          allowEdit=true
          allowActions=false
          isTooltip=true
        }}

        {{#if timeAttack}}
          <p>Время до цели: <span>{{formatSeconds timeAttack}}</span></p>
        {{/if}}
          <p>Свободно флотов: <span>{{vacantFleets}}</span></p>

        {{#if or planet.isHome planet.armyId}}
          <button
            class="
              cw--button
              cw--button_type_primary
              cw--button_type_primary_orange
              cw--CosmosAttackMenu__action
              btn-attack
              defend
            "
            disabled={{not canSendFleet}}
            data-sound="attack"
          >
            Отправить
          </button>
        {{else}}
          <button
            class="
              cw--button
              cw--button_type_primary
              cw--button_type_primary_orange
              cw--CosmosAttackMenu__action
              btn-attack
              defend
            "
            disabled={{not canSendFleet}}
            data-sound="attack"
          >
            Захватить
          </button>
          <button
            class="
              cw--button
              cw--button_type_primary
              cw--button_type_primary_orange
              cw--CosmosAttackMenu__action
              btn-attack
              return
            "
            disabled={{not canSendFleet}}
            data-sound="attack"
          >
            {{#if planet.mission}}Уничтожить{{else}}Исследовать{{/if}}
          </button>
        {{/if}}
      {{else if battle}}
        {{#if timeAttackBattle}}
          <p>Время до цели: <span>{{formatSeconds timeAttackBattle}}</span></p>
          <p>Свободно флотов: <span>{{vacantFleets}}</span></p>

          <button
            class="
              cw--button
              cw--button_type_primary
              cw--button_type_primary_orange
              cw--CosmosAttackMenu__action
              btn-attack
              help
            "
            data-sound="attack"
          >
            Отправить
          </button>
        {{/if}}
      {{else}}
        {{> SpaceFleetPopup args
          spaceEvent=ship
          isTooltip=true
        }}

        {{#if timeAttack}}
          <p>Время перехвата: <span>{{formatSeconds timeAttack}}</span></p>
        {{else}}
          <p>Не успеем перехватить</p>
        {{/if}}
          <p>Свободно флотов: <span>{{vacantFleets}}</span></p>

        <button
          class="
            cw--button
            cw--button_type_primary
            cw--button_type_primary_orange
            cw--CosmosAttackMenu__action
            btn-attack
            return
          "
          disabled={{not canSendFleet}}
          data-sound="attack"
        >
          Перехватить
        </button>
      {{/if}}
    </div>

    <button
      onClick={{closeWindow}}
      class="
        cw--button
        cw--button_close
        cw--CosmosAttackMenu__close
      "
      data-sound="close"
    ></button>
  </div>
</template>

<template name="cosmosFleetsInfo_table">
  <ul
    class="
      planets
      cw--FleetInfoPlanets
      {{#if options.compactFleetInfo}}cw--FleetInfoPlanets_compact{{/if}}
    "
  >
    {{#each fleets}}
      <li data-id="{{this._id}}"
        class="
          cw--FleetInfoPlanets__item
          {{#if eq this._id activeColonyId}}
            active
          {{else}}
            {{#if this.isHome}}
              home
            {{/if}}
          {{/if}}
          {{#if this.isBack}}
            cw--FleetInfoPlanets__item_back
          {{/if}}
        "
      >
        <h2 class="cw--FleetInfoPlanets__itemHead">
          {{this.name}}
        </h2>
        <div class="cw--FleetInfoPlanets__path">
          <div
            class="
              cw--FleetInfoPlanets__planet
              cw--FleetInfoPlanets__planet_start
            "
          >
            {{#if this.start}}
              {{> SpacePlanet args
                planet=this.start
                isCompact=options.compactFleetInfo
              }}
            {{else}}
              <a class="cw--FleetInfoPlanets__fleetReptiles"></a>
            {{/if}}
          </div>

          <a href="{{pathFor 'cosmos' hash=this.id}}"
            class="
              cw--FleetInfoPlanets__way
              cw--FleetInfoPlanets__way_{{../owner}}
            "
          >
            <time class="cw--FleetInfoPlanets__wayTime">
              {{formatSeconds (getTimeLeft this.timeEnd)}}
            </time>
            <div
              class="
                cw--FleetInfoPlanets__marker
                cw--FleetInfoPlanets__marker_{{../owner}}
              "
              style="
              {{#if this.isBack}}right{{else}}left{{/if}}: {{percentOfWay this.timeStart this.timeEnd}}%;"
              data-tooltip-direction="e"
            ></div>
          </a>

          <div
            class="
              cw--FleetInfoPlanets__planet
              cw--FleetInfoPlanets__planet_end
            "
          >
            {{#if this.finish}}
              {{> SpacePlanet args
                planet=this.finish
                isCompact=options.compactFleetInfo
              }}
            {{else}}
              <a class="cw--FleetInfoPlanets__fleetReptiles"
                href="{{pathFor 'cosmos' hash=this.spaceEvent.info.targetId}}" 
                data-tooltip-direction="e"
              >
              </a>
            {{/if}}
          </div>
        </div>
      </li>
    {{/each}}
  </ul>
</template>

<template name="cosmosFleetsInfo">
  <div class="cw--FleetInfoTable">
    {{#if userFleets}}
      {{> cosmosFleetsInfo_table fleets=userFleets owner='humans'}}
    {{/if}}
    {{#if reptileFleets}}
      {{> cosmosFleetsInfo_table fleets=reptileFleets owner='reptiles'}}
    {{/if}}
    {{#if battles}}
      {{#each battles}}
        <div>
          <a href="{{pathFor 'cosmos' hash=this.id}}">
            <img src="/img/game/battle/battleIcon.svg" width="30" height="30">
          </a>
          Сражение<br/>
          Раунд {{round}}
        </div>
      {{/each}}
    {{/if}}
  </div>
</template>


<template name="cosmosHistory">
  <div class="history">
    {{#if battles}}
      <table>
        <tr class="header">
          <th class="sides">Место боя</th>
          <th class="lost">Потери войск</th>
          <th class="result">Итог</th>
          <th class="time">Время</th>  
        </tr>
      </table>
      <div class="data scrollbar-inner">
        <table>
          {{#each battles}}
            <tr data-id="{{this._id}}">
              <td>
                {{#if eq this.userLocation this.location}}
                  <img src="/img/game/life.png" class="defense" data-tooltip="Защита" data-tooltip-direction="s"/> 
                {{else}}
                  <img src="/img/game/damage.png" class="attack" data-tooltip="Нападение" data-tooltip-direction="s"/> 
                {{/if}}
                
                {{#if this.planetId}}
                  {{#let battlePlanet=getBattlePlanet}}
                    {{> SpacePlanet args
                      planet=battlePlanet
                      isDisabled=battlePlanet.isDisabled
                      location=battlePlanet.location
                    }}
                  {{/let}}
                {{else}}
                  Космос
                {{/if}}
              </td>
              <td>
                {{#if this.lostUnitsCount}}
                  <div class="result">
                    {{declension this.lostUnitsCount 'Потерян' '' 'о' 'о'}} 
                    {{this.lostUnitsCount}} 
                    {{declension this.lostUnitsCount 'юнит' '' 'а' 'ов'}}
                  </div>
                  <div 
                    data-tooltip="Отображается стоимость потери по цене юнитов на текущий момент"
                    data-tooltip-direction="s"
                  >
                    {{> item_price price=this.lostUnitsPrice}}
                  </div>
                {{else}}
                  <h2>—</h2>
                {{/if}}

                <div class="details">
                  {{#if not this.isBattle1x1}}
                  Совместный бой
                  {{/if}}
                  {{#if this.userUnits}}
                    <table>
                      <tr class="header">
                        <th class="name"></th>
                        <th class="count">Вылетело</th>
                        <th class="count">Осталось</th>
                      </tr>
                      {{#each this.userUnits}}
                        <tr>
                          <td class="name humans">{{this.title}}</td>
                          <td class="count">{{formatNumberWithISO this.start}}</td>
                          <td class="count">{{formatNumberWithISO this.end}}</td>
                        </tr>
                      {{/each}}
                    </table>
                  {{/if}}
                </div>
              </td>
              <td>
                <div class="result
                  {{#if eq this.result 0}}tie{{/if}}
                  {{#if eq this.result 1}}victory{{/if}}
                  {{#if eq this.result 2}}defeat{{/if}}
                  {{#if eq this.result 3}}damage{{/if}}
                  {{#if eq this.result 4}}damageVictory{{/if}}
                ">
                  {{#if eq this.result 0}}Ничья{{/if}}
                  {{#if eq this.result 1}}Победа{{/if}}
                  {{#if eq this.result 2}}Поражение{{/if}}
                  {{#if eq this.result 3}}Нанесение Урона{{/if}}
                  {{#if eq this.result 4}}Бдыщь!{{/if}}
                </div>

                {{> item_price price=this.reward}}

                <div class="details">
                  {{#if this.enemyUnits}}
                    <table>
                      <tr class="header">
                        <th class="count">Вылетело</th>
                        <th class="count">Осталось</th>
                        <th class="name"></th>
                      </tr>
                      {{#each this.enemyUnits}}
                        <tr>
                          <td class="name reptiles">{{formatNumberWithISO this.title}}</td>
                          <td class="count">{{formatNumberWithISO this.start}}</td>
                          <td class="count">{{this.end}}</td>
                        </tr>
                      {{/each}}
                    </table>
                  {{/if}}
                </div>
              </td>
              <td 
                data-tooltip="{{formatDate this.timestamp}}"
                data-tooltip-direction="s"
              >
                {{#if isToday this.timestamp}}
                  {{formatHours this.timestamp}}
                {{else}}
                  {{formatYearMonthDay (multiply this.timestamp 1000)}}
                {{/if}}
              </td>
            </tr>
          {{/each}}
        </table>
      </div>
      {{> pages total=countTotal perPage=countPerPage}}
    {{else}}
      {{#if lt countTotal 1}}
        <h2>История боёв пуста</h2>
      {{/if}}
    {{/if}}
    <a class="btn-close" href="{{pathFor 'cosmos'}}" data-sound="close"></a>
  </div>

  {{#if battle}}
    {{> cosmosHistoryItem battle=battle}}
  {{/if}}

  {{#if isLoading}}
    {{> loading}}
  {{/if}}
</template>