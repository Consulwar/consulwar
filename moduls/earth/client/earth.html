<template name="earth">
  <div id="map-content" class="information"></div>
</template>

<template name="earthZonePopup">
  {{#if zone}}
    <div 
      class="point-popup" 
      style="left: {{position.x}}px; top: {{position.y}}px;"
    >
      <h2 title="{{info.name}}" class="{{#if info.isEnemy}}text-enemy{{else}}text-ours{{/if}}">
        {{zone.name}}
      </h2>
      {{#if zone.bonus}}
        <div>Бонус точки: {{zoneBonusLine}}</div>
      {{/if}}
      <div>Консулов: {{zone.usersCount}}</div>
      <!-- buttons -->
      <a class="btn-info" href="{{pathFor 'earthZone' group='earth' name=zone.name}}" data-sound="click">Информация</a>

      {{#if hasLink}}
      {{!-- Есть куда идти --}}
        {{#if notBattle}}
          {{!-- Нет битвы --}}
          {{#unless eq army.generalCommand ResponseToGeneral.ACCEPT}}
            <a class="btn-command" data-action="{{zone.name}}" data-sound="attack">
              {{#if eq army.zoneName zone.name}}
                Ждём
              {{else}}
                {{#if zone.isEnemy}}
                  В атаку
                {{else}}
                  Идём
                {{/if}}
              {{/if}}
            </a>
          {{/unless}}
        {{/if}}
        {{#if eq army.zoneName zone.name}}
          <a class="btn-reinforce" href="{{pathFor 'earthReserve' group='earth' name=zone.name}}" data-sound="click">Подкрепление</a>
        {{/if}}
      {{!-- Генерал --}}
        {{#if and (eq armyZone.general.username user.username) (not armyZone.general.command)}}
          <a class="btn-general-command" data-action="{{zone.name}}" data-sound="attack">
            Приказ:
            {{#if eq army.zoneName zone.name}}
              Ждём
            {{else}}
              {{#if zone.isEnemy}}
                В атаку
              {{else}}
                Идём
              {{/if}}
            {{/if}}
          </a>
        {{/if}}
      {{!-- end: Генерал --}}

        {{#if eq army.zoneName zone.name}}
          {{#if and zone.general.command (not (eq zone.general.command Command.NONE))}}
            {{!-- Генерал приказал --}}
            Генерал {{zone.general.username}} приказал:
            {{#if eq zone.general.command Command.MOVE}}
              Идем на {{zone.general.commandTarget}}
            {{else}}
              Ждём
            {{/if}}

            {{#if army.generalCommand}}
              Вы
              {{#if eq army.generalCommand ResponseToGeneral.ACCEPT}}
                согласились
              {{else}}
                не согласились
              {{/if}}
            {{else}}
              
              <a class="btn-response-yes" data-action="{{zone.name}}" data-sound="click">Да</a>
              <a class="btn-response-no" data-action="{{zone.name}}" data-sound="click">Нет</a>
            {{/if}}
          {{/if}}
        {{/if}}
      {{else}}
      {{!-- Некуда перемещаться --}}
        {{#if not zone.isEnemy}}
          <a class="btn-reinforce" href="{{pathFor 'earthReserve' group='earth' name=zone.name}}">Отправить</a>
        {{/if}}
      {{/if}}
      {{!-- Админка --}}
      {{#if eq user.role 'admin'}}
        <a class="btn-admin-panel" data-action="{{zone.name}}" data-sound="click">Админка</a>
      {{/if}}
    </div>
  {{/if}}
</template>

<template name="earthZoneInfo">
  {{#if info}}
    <div class="zone-info">
      <div class="summary-info">
        <h2>{{info.name}}</h2>
        <div>
          Захвачено на: {{info.capturedPercent}}%
          <div class="humans">Точек людей: {{info.userCount}}</div>
          <div class="reptiles">Точек рептилий: {{info.enemyCount}}</div>
        </div>
      </div>
      <div class="army-humans">
        <p>Люди<br><span>Сила: {{info.userPower}}</span></p>
        <ul>
          {{#each info.userArmy}}
            <li>
              <span>{{this.count}}
                {{#if this.userUnitsCount}} ({{this.userUnitsCount}}) {{/if}}
              </span>
              {{this.title}}
            </li>
          {{/each}}
        </ul>
      </div>
      <div class="army-reptiles">
        <p>Рептилоиды<br><span>Сила: {{info.enemyPower}}</span></p>
        <ul>
          {{#each info.enemyArmy}}
            <li>
              <span>{{this.count}}</span> {{this.title}}
            </li>
          {{/each}}
        </ul>
      </div>
      {{#if eq army.zoneName zone.name}}
        <a class="btn-reinforce" href="{{pathFor 'earthReserve' group='earth' name=info.name}}">Подкрепление</a>
      {{/if}}
      <a class="btn-close-horizontal" href="{{pathFor 'earth' group='earth'}}" data-sound="close"></a>
      <!-- <a class="btn-special">Спец атака</a> -->
    </div>
  {{/if}}
</template>

<template name="reserve">
  <div class="zone-reserve">
    {{#if units}}
      <ul class="items units">
        {{#each units}}
          <li 
            class="unit {{#if lt this.max 1}}disabled{{else}}active{{/if}}"
            data-id="{{this.id}}"
            data-max="{{this.max}}"
          >
            <a style="background-image: url({{this.icon}})"></a>
            <div class="max">{{formatNumberWithISO this.max}}</div>
            <input class="count" type="number" placeholder="Количество"  value="0">
          </li>
        {{/each}}
      </ul>
    {{/if}}
    
    <div class="description">
      <p>Как вам известно, Консул, на Земле идут ожесточённые бои против сил захватчиков. Рептилоиды не сдают позиции, а их силы всё растут. Галактический Совет не может поддерживать достаточное количество войск для обороны и наступления, поэтому освобождение нашей родной планеты загнётся без вашей поддержки. Отправить подкрепление на Активную Точку можно в любое время суток.</p><br/>

      <p class="remuneration">
        Ваша поддержка Военной Кампании не останется незамеченной, Консул. После отправки этих отрядов вы получите Очки Чести в размере:
        <div class="resources">
          <div class="honor">{{formatNumber honor}}</div>
        </div>
      </p>
      
      <a class="btn-all" data-sound="click">Выбрать всех</a>
      <a class="btn-send" data-sound="attack">Отправить</a>
    </div>

    <a class="btn-close-horizontal" href="{{pathFor 'earth' group='earth'}}" data-sound="close"></a>
  </div>
  {{> Assistant }}
</template>

<template name="earthHistory">
  <div class="history">
    {{#if battles}}
      <table>
        <tr class="header">
          <th class="sides">Событие</th>
          <th class="result">Итог</th>
          <th class="time">Время</th>
        </tr>
      </table>
      <div class="data">
        <table>
          {{#each battles}}
            <tr data-id="{{this._id}}">
              <td>
                {{#if eq this.moveType 'wait'}}
                  <span class="humans">Консулы</span>
                   остаются на точке 
                  <span class="humans">{{this.location}}</span>
                {{/if}}

                {{#if eq this.moveType 'defend'}}
                  <span class="reptiles">Рептилоиды ({{this.enemyLocation}})</span>
                   атакуют 
                  <span class="humans">Консулов ({{this.userLocation}})</span>
                {{/if}}

                {{#if eq this.moveType 'move'}}
                  {{#if this.enemyArmy}}
                    <span class="humans">Консулы ({{this.userLocation}})</span>
                     атакуют 
                    <span class="reptiles">Рептилоидов ({{this.enemyLocation}})</span>
                  {{else}}
                    <span class="humans">Консулы</span>
                     переходят на точку 
                    <span class="humans">{{this.location}}</span>
                  {{/if}}
                {{/if}}

                {{#if eq this.moveType 'fight'}}
                  <span class="humans">Консулы</span>
                   продолжают бой с 
                  <span class="reptiles">рептилоидами</span>
                   на точке 
                  <span class="reptiles">{{this.location}}</span>
                {{/if}}

                {{#if eq this.moveType 'retreat'}}
                  <span class="humans">Консулы</span>
                   оступают с точки 
                  <span class="reptiles">{{this.location}}</span>
                {{/if}}
              </td>
              <td>
                {{#if eq this.result 0}}Тактическая ничья{{/if}}
                {{#if eq this.result 1}}Героическая победа{{/if}}
                {{#if eq this.result 2}}Полное поражение{{/if}}
              </td>
              <td>{{formatDate this.timestamp}}</td>
            </tr>
          {{/each}}
        </table>
      </div>
      {{> pages total=countTotal perPage=countPerPage}}
    {{else}}
      {{#if lt countTotal 1}}
        <h2>История боев пуста</h2>
      {{/if}}
    {{/if}}
    <a class="btn-close" href="{{pathFor 'earth' group='earth'}}" data-sound="close"></a>
  </div>

  {{#if battle}}
    {{> earthHistoryItem battle=battle}}
  {{/if}}

  {{#if isLoading}}
    {{> loading}}
  {{/if}}
</template>

<template name="earthHistoryItem">
  <div class="history-item">
    {{#if battle}}
      <div
        class="
          result
          {{#if eq battle.result 0}}tie{{/if}}
          {{#if eq battle.result 1}}victory{{/if}}
          {{#if eq battle.result 2}}defeat{{/if}}
        "
      >
        {{#if eq battle.result 0}}Тактическая ничья{{/if}}
        {{#if eq battle.result 1}}Героическая победа{{/if}}
        {{#if eq battle.result 2}}Полное поражение{{/if}}
      </div>
      {{#if battle.userArmy}}
        <div class="user-army">
          <p class="humans">Люди</p>
          <table>
            <tr class="header">
              <th class="name"></th>
              <th class="count">Было</th>
              <th class="count">Осталось</th>
            </tr>
            {{#each (getArmyInfo battle.userArmy battle.userArmyRest)}}
              <tr>
                <td class="name humans">{{this.name}}</td>
                <td class="count">{{formatNumberWithISO this.start}}</td>
                <td class="count">{{formatNumberWithISO this.end}}</td>
              </tr>
            {{/each}}
          </table>
        </div>
      {{/if}}
      {{#if battle.enemyArmy}}
        <div class="enemy-army">
          <p class="reptiles">Рептилоиды</p>
          <table>
            <tr class="header">
              <th class="count">Осталось</th>
              <th class="count">Было</th>
              <th class="name"></th>
            </tr>
            {{#each (getArmyInfo battle.enemyArmy battle.enemyArmyRest)}}
              <tr>
                <td class="count">{{formatNumberWithISO this.end}}</td>
                <td class="count">{{formatNumberWithISO this.start}}</td>
                <td class="name reptiles">{{this.name}}</td>
              </tr>
            {{/each}}
          </table>
        </div>
      {{/if}}
    {{/if}}
    <a class="btn-back" href="{{pathFor 'earthHistory' group='earth' page=currentPage}}" data-sound="click"></a>
  </div>
</template>
